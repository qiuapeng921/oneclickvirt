# ä»»åŠ¡ç³»ç»Ÿ (Task System)

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å¼€å‘çš„é«˜æ€§èƒ½å¼‚æ­¥ä»»åŠ¡ç®¡ç†ç³»ç»Ÿï¼Œä¸“ä¸ºäº‘ä¸»æœºç®¡ç†å¹³å°è®¾è®¡ã€‚ç³»ç»Ÿé‡‡ç”¨ç°ä»£åŒ–çš„ **Channel å·¥ä½œæ±  (Worker Pool)** æ¶æ„ï¼Œæä¾›å¼ºå¤§çš„å¹¶å‘æ§åˆ¶ã€ä»»åŠ¡è°ƒåº¦å’ŒçŠ¶æ€ç®¡ç†èƒ½åŠ›ã€‚

## æ ¸å¿ƒç‰¹æ€§

- **Channel å·¥ä½œæ± **: åŸºäº Go Channel å®ç°çš„é«˜æ•ˆå¹¶å‘æ§åˆ¶
- **Provider çº§åˆ«éš”ç¦»**: æ¯ä¸ªäº‘æœåŠ¡å•†ç‹¬ç«‹çš„å·¥ä½œæ± ï¼Œé¿å…ç›¸äº’å½±å“
- **åŠ¨æ€å¹¶å‘è°ƒæ•´**: æ”¯æŒè¿è¡Œæ—¶è°ƒæ•´ Provider çš„å¹¶å‘æ•°é…ç½®
- **å†…å­˜å‹å¥½**: æ— é”è®¾è®¡ï¼Œè‡ªåŠ¨åƒåœ¾å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼

## æ”¯æŒçš„ä»»åŠ¡ç±»å‹

- **create**: åˆ›å»ºäº‘ä¸»æœºå®ä¾‹ (é»˜è®¤30åˆ†é’Ÿè¶…æ—¶)
- **start**: å¯åŠ¨å®ä¾‹ (5åˆ†é’Ÿè¶…æ—¶)
- **stop**: åœæ­¢å®ä¾‹ (5åˆ†é’Ÿè¶…æ—¶)
- **restart**: é‡å¯å®ä¾‹ (10åˆ†é’Ÿè¶…æ—¶)
- **delete**: åˆ é™¤å®ä¾‹ (10åˆ†é’Ÿè¶…æ—¶)
- **reset**: é‡ç½®å®ä¾‹ (20åˆ†é’Ÿè¶…æ—¶)
- **reset-password**: é‡ç½®å¯†ç  (5åˆ†é’Ÿè¶…æ—¶)

## ä»»åŠ¡çŠ¶æ€ç®¡ç†

å®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ”¯æŒä»¥ä¸‹çŠ¶æ€ï¼š

```
pending â†’ running â†’ completed
   â†“         â†“         â†‘
cancelled   failed â†â”€â”€â”€â”˜
   â†“         â†“
timeout   cancelling
```

**çŠ¶æ€è¯´æ˜ï¼š**

- `pending`: ä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…æ‰§è¡Œ
- `running`: ä»»åŠ¡æ­£åœ¨æ‰§è¡Œ
- `completed`: ä»»åŠ¡æˆåŠŸå®Œæˆ
- `failed`: ä»»åŠ¡æ‰§è¡Œå¤±è´¥
- `cancelled`: ä»»åŠ¡å·²å–æ¶ˆ
- `cancelling`: ä»»åŠ¡å–æ¶ˆä¸­
- `timeout`: ä»»åŠ¡æ‰§è¡Œè¶…æ—¶

## å¹¶å‘æ§åˆ¶

### ğŸ›¡ï¸ å¹¶å‘æ¨¡å¼

- **ä¸²è¡Œæ¨¡å¼**: `AllowConcurrentTasks = false` (é»˜è®¤)
- **å¹¶å‘æ¨¡å¼**: `AllowConcurrentTasks = true` + `MaxConcurrentTasks` é…ç½®
- **é˜Ÿåˆ—ç¼“å†²**: æ”¯æŒä»»åŠ¡æ’é˜Ÿï¼Œé¿å…æ‹¥å¡
- **è¶…æ—¶ä¿æŠ¤**: ä»»åŠ¡çº§åˆ«å’Œç³»ç»Ÿçº§åˆ«çš„è¶…æ—¶æœºåˆ¶

## æ ¸å¿ƒç»„ä»¶

### TaskService

ä¸»è¦çš„ä»»åŠ¡ç®¡ç†æœåŠ¡ï¼Œæä¾›ï¼š

- ä»»åŠ¡åˆ›å»ºã€å¯åŠ¨ã€å–æ¶ˆ
- å·¥ä½œæ± ç®¡ç†
- çŠ¶æ€æŸ¥è¯¢å’Œç›‘æ§
- ä¼˜é›…å…³é—­

**æ ¸å¿ƒç»“æ„ï¼š**

```go
type TaskService struct {
    dbService       *database.DatabaseService
    runningContexts map[uint]*TaskContext
    contextMutex    sync.RWMutex
    providerPools   map[uint]*ProviderWorkerPool
    poolMutex       sync.RWMutex
    shutdown        chan struct{}
    wg              sync.WaitGroup
    ctx             context.Context
    cancel          context.CancelFunc
}
```

### ProviderWorkerPool

Provider ä¸“ç”¨å·¥ä½œæ± ï¼Œç‰¹æ€§ï¼š

- ç‹¬ç«‹çš„ä»»åŠ¡é˜Ÿåˆ—
- å¯é…ç½®çš„å·¥ä½œè€…æ•°é‡
- ä¸Šä¸‹æ–‡å–æ¶ˆæ”¯æŒ
- è‡ªåŠ¨è´Ÿè½½å‡è¡¡

**æ ¸å¿ƒç»“æ„ï¼š**

```go
type ProviderWorkerPool struct {
    ProviderID  uint
    TaskQueue   chan TaskRequest
    WorkerCount int
    Ctx         context.Context
    Cancel      context.CancelFunc
    TaskService *TaskService
}
```

### TaskStateManager

ç»Ÿä¸€çš„ä»»åŠ¡çŠ¶æ€ç®¡ç†å™¨ï¼š

- è·¨è¡¨çŠ¶æ€åŒæ­¥
- äº‹åŠ¡å®‰å…¨æ›´æ–°
- çŠ¶æ€æµè½¬éªŒè¯
- é”™è¯¯å¤„ç†

## ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºä»»åŠ¡

```go
taskService := task.GetTaskService()
task, err := taskService.CreateTask(
    userID,      // ç”¨æˆ·ID
    &providerID, // Provider ID
    &instanceID, // å®ä¾‹ID
    "create",    // ä»»åŠ¡ç±»å‹
    taskData,    // ä»»åŠ¡æ•°æ® (JSON)
    1800,        // è¶…æ—¶æ—¶é—´(ç§’)
)
```

### å¯åŠ¨ä»»åŠ¡

```go
err := taskService.StartTask(taskID)
```

### æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

```go
tasks, total, err := taskService.GetAdminTasks(request)
```

### å–æ¶ˆä»»åŠ¡

```go
err := taskService.CancelTask(taskID, userID)
```

## é…ç½®å‚æ•°

### Provider çº§åˆ«é…ç½®

```yaml
allowConcurrentTasks: true    # æ˜¯å¦å…è®¸å¹¶å‘
maxConcurrentTasks: 3         # æœ€å¤§å¹¶å‘æ•°
taskPollInterval: 60          # è½®è¯¢é—´éš”(ç§’)
enableTaskPolling: true       # æ˜¯å¦å¯ç”¨è½®è¯¢
```

### ç³»ç»Ÿçº§åˆ«é…ç½®

- é»˜è®¤è¶…æ—¶æ—¶é—´: 30åˆ†é’Ÿ
- é˜Ÿåˆ—ç¼“å†²å¤§å°: å¹¶å‘æ•° Ã— 2
- å–æ¶ˆç›‘å¬é—´éš”: 1ç§’
- ä¼˜é›…å…³é—­ç­‰å¾…: 5ç§’

## ç›‘æ§æŒ‡æ ‡

### ä»»åŠ¡ç»Ÿè®¡

- æ€»ä»»åŠ¡æ•°
- å„çŠ¶æ€ä»»åŠ¡æ•°é‡
- Provider ä»»åŠ¡åˆ†å¸ƒ
- æ‰§è¡Œæ—¶é—´ç»Ÿè®¡

### æ€§èƒ½æŒ‡æ ‡

- é˜Ÿåˆ—é•¿åº¦
- å·¥ä½œè€…åˆ©ç”¨ç‡
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯ç‡ç»Ÿè®¡

## æœ€ä½³å®è·µ

### 1. å¹¶å‘é…ç½®

```go
// è®¡ç®—å¯†é›†å‹ä»»åŠ¡å»ºè®®è¾ƒä½å¹¶å‘
maxConcurrentTasks: 1-2

// I/O å¯†é›†å‹ä»»åŠ¡å¯ä»¥è¾ƒé«˜å¹¶å‘
maxConcurrentTasks: 3-5
```

### 2. é”™è¯¯å¤„ç†

- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- å®ç°é‡è¯•æœºåˆ¶
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- ç›‘æ§å¼‚å¸¸ä»»åŠ¡

### 3. èµ„æºç®¡ç†

- å®šæœŸæ¸…ç†è¶…æ—¶ä»»åŠ¡
- ç›‘æ§å†…å­˜ä½¿ç”¨
- åˆç†é…ç½®é˜Ÿåˆ—å¤§å°
- åŠæ—¶é‡Šæ”¾èµ„æº

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Task API      â”‚â”€â”€â”€â–¶â”‚   TaskService    â”‚â”€â”€â”€â–¶â”‚ ProviderPool    â”‚
â”‚   (HTTP/gRPC)   â”‚    â”‚   (Singleton)    â”‚    â”‚ (Per Provider)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ TaskStateManagerâ”‚    â”‚   Worker Pool     â”‚
                       â”‚ (Unified State) â”‚    â”‚ (Channel Based)   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚    Database     â”‚    â”‚  Task Execution   â”‚
                       â”‚   (GORM/MySQL)  â”‚    â”‚ (Provider APIs)   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API æ¥å£

### GetTaskService

è·å–ä»»åŠ¡æœåŠ¡å•ä¾‹å®ä¾‹ã€‚

```go
func GetTaskService() *TaskService
```

### CreateTask

åˆ›å»ºæ–°ä»»åŠ¡ã€‚

```go
func (s *TaskService) CreateTask(
    userID uint,
    providerID *uint,
    instanceID *uint,
    taskType string,
    taskData string,
    timeoutDuration int,
) (*adminModel.Task, error)
```

**å‚æ•°è¯´æ˜ï¼š**

- `userID`: ç”¨æˆ·ID
- `providerID`: Provider IDï¼ˆå¯é€‰ï¼‰
- `instanceID`: å®ä¾‹IDï¼ˆå¯é€‰ï¼‰
- `taskType`: ä»»åŠ¡ç±»å‹
- `taskData`: ä»»åŠ¡æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
- `timeoutDuration`: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼

### StartTask

å¯åŠ¨ä»»åŠ¡æ‰§è¡Œã€‚

```go
func (s *TaskService) StartTask(taskID uint) error
```

### CancelTask

ç”¨æˆ·å–æ¶ˆä»»åŠ¡ã€‚

```go
func (s *TaskService) CancelTask(taskID uint, userID uint) error
```

### CancelTaskByAdmin

ç®¡ç†å‘˜å–æ¶ˆä»»åŠ¡ã€‚

```go
func (s *TaskService) CancelTaskByAdmin(taskID uint, reason string) error
```

### GetUserTasks

è·å–ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨ã€‚

```go
func (s *TaskService) GetUserTasks(
    userID uint,
    req userModel.UserTasksRequest,
) ([]userModel.TaskResponse, int64, error)
```

### GetAdminTasks

è·å–ç®¡ç†å‘˜ä»»åŠ¡åˆ—è¡¨ã€‚

```go
func (s *TaskService) GetAdminTasks(
    req adminModel.AdminTaskListRequest,
) ([]adminModel.AdminTaskResponse, int64, error)
```

### Shutdown

ä¼˜é›…å…³é—­ä»»åŠ¡æœåŠ¡ã€‚

```go
func (s *TaskService) Shutdown()
```

## é”™è¯¯å¤„ç†

ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é”™è¯¯ä¼šè¢«è®°å½•åˆ°ä»»åŠ¡çš„ `error_message` å­—æ®µï¼Œå¹¶è‡ªåŠ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º `failed`ã€‚

**å¸¸è§é”™è¯¯åœºæ™¯ï¼š**

- Providerè¿æ¥å¤±è´¥
- å®ä¾‹æ“ä½œè¶…æ—¶
- èµ„æºä¸è¶³
- é…ç½®é”™è¯¯
- ç½‘ç»œå¼‚å¸¸

## è¶…æ—¶æœºåˆ¶

### ä»»åŠ¡çº§åˆ«è¶…æ—¶

æ¯ä¸ªä»»åŠ¡ç±»å‹éƒ½æœ‰é»˜è®¤çš„è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿå¯ä»¥åœ¨åˆ›å»ºä»»åŠ¡æ—¶æŒ‡å®šè‡ªå®šä¹‰è¶…æ—¶æ—¶é—´ã€‚

### ä¸Šä¸‹æ–‡è¶…æ—¶

ä½¿ç”¨ Context å®ç°è¶…æ—¶æ§åˆ¶ï¼Œè¶…æ—¶åä¼šè‡ªåŠ¨å–æ¶ˆä»»åŠ¡æ‰§è¡Œå¹¶æ¸…ç†èµ„æºã€‚

### å–æ¶ˆç›‘å¬

åå°ç›‘å¬ä»»åŠ¡å–æ¶ˆä¿¡å·ï¼Œæ”¯æŒç”¨æˆ·ä¸»åŠ¨å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ã€‚

## èµ„æºç®¡ç†

### è‡ªåŠ¨æ¸…ç†

- ä»»åŠ¡å®Œæˆåè‡ªåŠ¨æ¸…ç†è¿è¡Œæ—¶ä¸Šä¸‹æ–‡
- é‡Šæ”¾ Provider èµ„æºè®¡æ•°
- æ¸…ç†ä¸´æ—¶æ•°æ®

### å¯åŠ¨æ—¶æ¢å¤

æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨å°†æ‰€æœ‰ `running` çŠ¶æ€çš„ä»»åŠ¡æ ‡è®°ä¸º `failed`ï¼Œé¿å…çŠ¶æ€ä¸ä¸€è‡´ã€‚

## æ—¥å¿—è®°å½•

ä»»åŠ¡æœåŠ¡ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—è®°å½•æ‰€æœ‰å…³é”®æ“ä½œï¼š

- ä»»åŠ¡åˆ›å»º/å¯åŠ¨/å®Œæˆ
- çŠ¶æ€å˜æ›´
- é”™è¯¯ä¿¡æ¯
- æ€§èƒ½æŒ‡æ ‡

## æ€§èƒ½è€ƒè™‘

- Channel å·¥ä½œæ± æ— é”è®¾è®¡ï¼Œå‡å°‘é”ç«äº‰
- Provider çº§åˆ«éš”ç¦»ï¼Œæé«˜å¹¶å‘æ€§èƒ½
- è‡ªåŠ¨åƒåœ¾å›æ”¶ï¼Œé¿å…å†…å­˜æ³„æ¼
- ä»»åŠ¡æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–æ•°æ®åº“è®¿é—®

## æ¶æ„è®¾è®¡

```
server/service/task/
â”œâ”€â”€ service.go          # ä»»åŠ¡æœåŠ¡ä¸»å®ç°
â””â”€â”€ state_manager.go    # ä»»åŠ¡çŠ¶æ€ç®¡ç†å™¨
```
